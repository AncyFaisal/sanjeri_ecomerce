<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #431405;
            --background-color: #fff8f5;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            line-height: 1.6;
        }
        
        .breadcrumb {
            background: transparent;
            padding: 0;
        }
        
        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .product-image {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .thumbnail {
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .thumbnail.active {
            border-color: var(--primary-color);
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
        }
        
        .stock-badge {
            font-size: 0.9rem;
            padding: 5px 12px;
        }
        
        .discount-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .btn-add-cart {
            background-color: #8B0000;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            transition: all 0.3s;
        }
        
        .btn-add-cart:hover {
            background-color: #5a0c1d;
            transform: translateY(-2px);
        }
        
        .btn-add-cart:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        /* Go to Cart button style */
        .btn-go-to-cart {
            background-color: #28a745 !important;
            color: white !important;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            transition: all 0.3s;
        }
        
        .btn-go-to-cart:hover {
            background-color: #218838 !important;
            transform: translateY(-2px);
        }
        
        .variant-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .variant-option:hover {
            border-color: var(--primary-color);
            background-color: #fff8f5;
        }
        
        .variant-option.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }
        
        .zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .zoom-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .close-zoom {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
        
        .related-product {
            transition: transform 0.3s;
        }
        
        .related-product:hover {
            transform: translateY(-5px);
        }
        
        /* Notification styles */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header (Same as your homepage) -->
    <!-- Include your header here -->

    <!-- Main Content -->
    <div class="container py-4">
        <!-- CSRF Token for AJAX requests -->
        {% csrf_token %}
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                {% for crumb in breadcrumbs %}
                    {% if not forloop.last %}
                        <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.name }}</a></li>
                    {% else %}
                        <li class="breadcrumb-item active">{{ crumb.name }}</li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>

        <div class="row">
            <!-- Product Images -->
            <div class="col-md-6">
                <div class="product-image mb-4">
                    <img 
                        id="mainImage" 
                        src="{% if primary_image %}{{ primary_image.image.url }}{% elif product.main_image %}{{ product.main_image.url }}{% else %}https://via.placeholder.com/500x500?text=No+Image{% endif %}" 
                        alt="{{ product.name }}" 
                        class="img-fluid w-100"
                        style="height: 500px; object-fit: cover; cursor: zoom-in;"
                        onclick="openZoom()"
                    >
                </div>
                
                <!-- Thumbnail Gallery -->
                {% if product_images %}
                <div class="row">
                    {% for image in product_images %}
                    <div class="col-3 mb-3">
                        <img 
                            src="{{ image.image.url }}" 
                            alt="{{ product.name }}" 
                            class="img-fluid thumbnail {% if forloop.first %}active{% endif %}"
                            style="height: 100px; object-fit: cover;"
                            onclick="changeMainImage('{{ image.image.url }}', this)"
                        >
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Product Details -->
            <div class="col-md-6">
                <h1 class="h2 mb-3">{{ product.name }}</h1>
                
                <!-- Ratings -->
                <div class="d-flex align-items-center mb-3">
                    <div class="text-warning me-2">
                        {% with rating=product.avg_rating|default:4.0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>
                    <span class="text-muted">({{ product.rating_count }} reviews)</span>
                </div>

                <!-- Variant Selection -->
                {% if variants %}
                <div class="mb-4">
                    <h5>Select Variant</h5>
                    <div id="variant-options">
                        {% for variant in variants %}
                        <div class="variant-option {% if forloop.first %}selected{% endif %}" 
                             data-variant-id="{{ variant.id }}"
                             data-price="{{ variant.price }}"
                             data-discount-price="{{ variant.discount_price|default:'' }}"
                             data-stock="{{ variant.stock }}"
                             data-sku="{{ variant.sku }}"
                             data-volume="{{ variant.volume_ml }}"
                             data-gender="{{ variant.gender }}"
                             onclick="selectVariant(this)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ variant.volume_ml }}ml - {{ variant.gender }}</strong>
                                    <div class="small">
                                        {% if variant.discount_price %}
                                            <span class="text-danger fw-bold">‚Çπ{{ variant.discount_price }}</span>
                                            <span class="original-price ms-2">‚Çπ{{ variant.price }}</span>
                                        {% else %}
                                            <span class="fw-bold">‚Çπ{{ variant.price }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="d-block {% if variant.stock > 10 %}text-success{% elif variant.stock > 0 %}text-warning{% else %}text-danger{% endif %}">
                                        {% if variant.stock > 10 %}In Stock{% elif variant.stock > 0 %}Only {{ variant.stock }} left{% else %}Out of Stock{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Selected Variant Details -->
                <div class="mb-4 p-3 border rounded bg-light">
                    <h6>Selected Variant Details</h6>
                    <div id="selected-variant-details">
                        {% with first_variant=variants.first %}
                        <div class="row small">
                            <div class="col-6">
                                <strong>Volume:</strong> {{ first_variant.volume_ml }}ml
                            </div>
                            <div class="col-6">
                                <strong>Gender:</strong> {{ first_variant.gender }}
                            </div>
                            <div class="col-6">
                                <strong>Price:</strong> 
                                {% if first_variant.discount_price %}
                                    <span class="text-danger">‚Çπ{{ first_variant.discount_price }}</span>
                                    <small class="original-price">‚Çπ{{ first_variant.price }}</small>
                                {% else %}
                                    ‚Çπ{{ first_variant.price }}
                                {% endif %}
                            </div>
                            <div class="col-6">
                                <strong>Stock:</strong> 
                                <span class="{% if first_variant.stock > 10 %}text-success{% elif first_variant.stock > 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ first_variant.stock }}
                                </span>
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                     <!-- Hidden field to store current variant ID -->
    <input type="hidden" id="current-variant-id" value="{{ variants.first.id }}">
                </div>
                {% endif %}

                <!-- Description -->
                <div class="mb-4">
                    <h5>Description</h5>
                    <p class="text-muted">{{ product.description }}</p>
                </div>

                <!-- Product Details -->
                <div class="mb-4">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Brand:</strong></td>
                            <td>{{ product.brand|default:"Not specified" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fragrance Type:</strong></td>
                            <td>{{ product.fragrance_type|default:"Not specified" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Occasion:</strong></td>
                            <td>{{ product.occasion|default:"All occasions" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Base SKU:</strong></td>
                            <td>{{ product.sku }}</td>
                        </tr>
                    </table>
                </div>

                <!-- Add to Cart Button -->
                <div class="d-grid gap-2 d-md-flex">
                    {% if variants and variants.first.stock > 0 %}
                        <button class="btn btn-add-cart flex-fill" id="add-to-cart-btn">
                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        </button>
                    {% else %}
                        <button class="btn btn-add-cart flex-fill" disabled>
                            <i class="fas fa-times-circle me-2"></i>Out of Stock
                        </button>
                    {% endif %}
                </div>

                <!-- Additional Info -->
                <div class="mt-4 pt-4 border-top">
                    <div class="row text-center">
                        <div class="col-4">
                            <i class="fas fa-shipping-fast text-primary mb-2"></i>
                            <p class="small mb-0">Free Shipping</p>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-undo-alt text-primary mb-2"></i>
                            <p class="small mb-0">Easy Returns</p>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-shield-alt text-primary mb-2"></i>
                            <p class="small mb-0">Secure Payment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Customer Reviews</h3>
                
                {% if product.rating_count > 0 %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h2 class="text-primary">{{ product.avg_rating|default:0 }}</h2>
                                <div class="text-warning mb-2">
                                    {% with rating=product.avg_rating|default:0 %}
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                                <p class="text-muted">Based on {{ product.rating_count }} reviews</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="review mb-4">
                            <div class="d-flex justify-content-between">
                                <h6>John Doe</h6>
                                <small class="text-muted">2 weeks ago</small>
                            </div>
                            <div class="text-warning mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                            <p class="text-muted">Amazing fragrance! Long lasting and perfect for daily use.</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No reviews yet</h5>
                    <p class="text-muted">Be the first to review this product!</p>
                    <button class="btn btn-outline-primary">Write a Review</button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Related Products -->
        {% if related_products %}
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Related Products</h3>
                <div class="row">
                    {% for related in related_products %}
                    <div class="col-lg-3 col-md-4 col-6 mb-4">
                        <div class="card related-product h-100">
                            <a href="{% url 'product_detail' related.id %}">
                                <img 
                                    src="{% if related.main_image %}{{ related.main_image.url }}{% else %}https://via.placeholder.com/300x300?text=No+Image{% endif %}" 
                                    class="card-img-top" 
                                    alt="{{ related.name }}"
                                    style="height: 200px; object-fit: cover;"
                                >
                            </a>
                            <div class="card-body">
                                <h6 class="card-title">{{ related.name }}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    {% if related.min_price == related.max_price %}
                                        <span class="text-dark fw-bold">‚Çπ{{ related.min_price }}</span>
                                    {% else %}
                                        <span class="text-dark fw-bold">‚Çπ{{ related.min_price }} - ‚Çπ{{ related.max_price }}</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ related.variants.count }} variants</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Image Zoom Modal -->
    <div id="zoomModal" class="zoom-modal">
        <span class="close-zoom" onclick="closeZoom()">&times;</span>
        <img id="zoomedImage" src="" alt="">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let selectedVariantId = {% if variants %}{{ variants.first.id }}{% else %}null{% endif %};
        let isButtonGoToCart = false;

        // ==================== PAGE LOAD INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ Product detail page loaded');
            
            // Initialize button state
            initializeButtonState();
            
            // Check if variant is already in cart (from localStorage)
            checkLocalStorageForVariant();
        });

        // ==================== IMAGE GALLERY FUNCTIONS ====================
        function changeMainImage(src, element) {
            document.getElementById('mainImage').src = src;
            document.getElementById('zoomedImage').src = src;
            
            // Remove active class from all thumbnails
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            
            // Add active class to clicked thumbnail
            element.classList.add('active');
        }
        
        function openZoom() {
            document.getElementById('zoomModal').style.display = 'flex';
        }
        
        function closeZoom() {
            document.getElementById('zoomModal').style.display = 'none';
        }
        
        // Close modal when clicking outside image
        document.getElementById('zoomModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeZoom();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeZoom();
            }
        });

        // ==================== VARIANT SELECTION FUNCTIONS ====================
        function selectVariant(element) {
            // Remove selected class from all variants
            document.querySelectorAll('.variant-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked variant
            element.classList.add('selected');
            
            // Update selected variant ID
            selectedVariantId = element.dataset.variantId;
            
            // Update variant details display
            updateVariantDetails(element);
            
            // Update add to cart button based on stock
            updateAddToCartButton(parseInt(element.dataset.stock));
            
            // Check if this variant is already in cart
            checkIfVariantInCart(selectedVariantId);
        }
        
        function updateVariantDetails(element) {
            const detailsHtml = `
                <div class="row small">
                    <div class="col-6">
                        <strong>Volume:</strong> ${element.dataset.volume}ml
                    </div>
                    <div class="col-6">
                        <strong>Gender:</strong> ${element.dataset.gender}
                    </div>
                    <div class="col-6">
                        <strong>Price:</strong> 
                        ${element.dataset.discountPrice ? 
                            `<span class="text-danger">‚Çπ${element.dataset.discountPrice}</span>
                             <small class="original-price">‚Çπ${element.dataset.price}</small>` :
                            `‚Çπ${element.dataset.price}`
                        }
                    </div>
                    <div class="col-6">
                        <strong>Stock:</strong> 
                        <span class="${parseInt(element.dataset.stock) > 10 ? 'text-success' : parseInt(element.dataset.stock) > 0 ? 'text-warning' : 'text-danger'}">
                            ${element.dataset.stock}
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('selected-variant-details').innerHTML = detailsHtml;
        }
        
        function updateAddToCartButton(stock) {
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (!addToCartBtn) return;
            
            if (stock > 0) {
                addToCartBtn.disabled = false;
                // Don't change text here - let initializeButtonState handle it
            } else {
                addToCartBtn.disabled = true;
                addToCartBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Out of Stock';
                addToCartBtn.classList.remove('btn-go-to-cart');
                addToCartBtn.classList.add('btn-add-cart');
            }
        }

        // ==================== BUTTON STATE MANAGEMENT ====================
        function initializeButtonState() {
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (!addToCartBtn) return;
            
            // Set initial click handler
            addToCartBtn.addEventListener('click', handleAddToCartClick);
        }
        
        function changeButtonToGoToCart() {
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (!addToCartBtn) return;
            
            addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Go to Cart';
            addToCartBtn.classList.remove('btn-add-cart');
            addToCartBtn.classList.add('btn-go-to-cart');
            addToCartBtn.disabled = false;
            
            // Change the click handler to redirect to cart
            addToCartBtn.onclick = function() {
                window.location.href = '{% url "cart" %}';
            };
            
            isButtonGoToCart = true;
            console.log('‚úÖ Button changed to "Go to Cart"');
        }
        
        function changeButtonToAddToCart() {
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (!addToCartBtn) return;
            
            addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Add to Cart';
            addToCartBtn.classList.remove('btn-go-to-cart');
            addToCartBtn.classList.add('btn-add-cart');
            addToCartBtn.disabled = false;
            
            // Reset click handler
            addToCartBtn.onclick = handleAddToCartClick;
            
            isButtonGoToCart = false;
            console.log('‚úÖ Button changed to "Add to Cart"');
        }

        // ==================== ADD TO CART FUNCTION ====================
        async function handleAddToCartClick() {
            const addToCartBtn = this;
            
            if (!selectedVariantId) {
                showNotification('Please select a variant first', 'error');
                return;
            }
            
            // Check if button already says "Go to Cart"
            if (isButtonGoToCart) {
                window.location.href = '{% url "cart" %}';
                return;
            }
            
            const quantity = 1;
            
            // Get CSRF token
            let csrfToken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            
            if (!csrfToken) {
                showNotification('Security error: Please refresh the page and try again.', 'error');
                return;
            }
            
            // Show loading state
            const originalText = addToCartBtn.innerHTML;
            addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
            addToCartBtn.disabled = true;
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('quantity', quantity);
                formData.append('csrfmiddlewaretoken', csrfToken);
                
                console.log('üõí Adding variant to cart:', selectedVariantId);
                
                // Make AJAX request
                const response = await fetch(`/cart/add/${selectedVariantId}/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                // Check response type
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                    console.log('üõí JSON Response:', result);
                    
                    if (result.success) {
                        // Show success message
                        showNotification(result.message || 'Product added to cart!', 'success');
                        
                        // Update cart count in header
                        if (result.cart_total_items !== undefined) {
                            updateCartCount(result.cart_total_items);
                        }
                        
                        // Change button to "Go to Cart"
                        changeButtonToGoToCart();
                        
                        // Store in localStorage
                        localStorage.setItem(`cart_variant_${selectedVariantId}`, 'true');
                        
                        // Optionally redirect after delay
                        // setTimeout(() => {
                        //     window.location.href = '{% url "cart" %}';
                        // }, 1500);
                        
                    } else {
                        showNotification(result.message || 'Error adding to cart', 'error');
                        addToCartBtn.innerHTML = originalText;
                        addToCartBtn.disabled = false;
                    }
                } else {
                    // Handle HTML response (redirect)
                    console.log('üõí HTML response received');
                    showNotification('Product added! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "cart" %}';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Add to cart error:', error);
                showNotification('Network error. Please try again.', 'error');
                addToCartBtn.innerHTML = originalText;
                addToCartBtn.disabled = false;
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showNotification(message, type) {
            // Remove any existing notifications
            document.querySelectorAll('.custom-notification').forEach(el => el.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `custom-notification alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'}`;
            notification.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ Success!' : type === 'warning' ? '‚ö†Ô∏è Warning!' : '‚ùå Error!'}</strong>
                <div>${message}</div>
                <button type="button" class="btn-close" onclick="this.parentElement.remove()" style="float: right;"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function updateCartCount(count) {
            const cartCountElements = document.querySelectorAll('.cart-count');
            cartCountElements.forEach(element => {
                element.textContent = count;
                element.style.display = count > 0 ? 'flex' : 'none';
            });
            console.log('üõí Cart count updated to:', count);
        }
        
        function checkLocalStorageForVariant() {
            if (selectedVariantId) {
                const inCart = localStorage.getItem(`cart_variant_${selectedVariantId}`);
                if (inCart === 'true') {
                    console.log('üì¶ Variant found in localStorage, updating button');
                    changeButtonToGoToCart();
                }
            }
        }
        
        function checkIfVariantInCart(variantId) {
            // First check localStorage
            const inCart = localStorage.getItem(`cart_variant_${variantId}`);
            if (inCart === 'true') {
                changeButtonToGoToCart();
            } else {
                changeButtonToAddToCart();
            }
            
            // Optionally check with server (if you have an API endpoint)
            // checkWithServer(variantId);
        }
        
        // Optional: Server check function
        async function checkWithServer(variantId) {
            try {
                const response = await fetch(`/cart/check/${variantId}/`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.in_cart) {
                        changeButtonToGoToCart();
                        localStorage.setItem(`cart_variant_${variantId}`, 'true');
                    }
                }
            } catch (error) {
                console.log('Server check failed, using localStorage only');
            }
        }

        // ==================== ADD TO CART BUTTON MANAGEMENT ====================

// Function to check if variant is in cart (server check)
async function checkCartForVariant(variantId, button) {
    try {
        const response = await fetch(`/cart/check-variant/${variantId}/`);
        if (response.ok) {
            const data = await response.json();
            if (data.in_cart) {
                changeButtonToGoToCart();
            } else {
                changeButtonToAddToCart();
            }
        }
    } catch (error) {
        console.log('Server check failed, using localStorage');
        // Fallback to localStorage
        if (localStorage.getItem(`cart_variant_${variantId}`)) {
            changeButtonToGoToCart();
        }
    }
}

// Function to reset cart button (called when cart is cleared)
function resetCartButton() {
    const button = document.getElementById('add-to-cart-btn');
    if (button) {
        changeButtonToAddToCart();
        
        // Remove from localStorage
        const variantId = selectedVariantId || document.getElementById('current-variant-id')?.value;
        if (variantId) {
            localStorage.removeItem(`cart_variant_${variantId}`);
            localStorage.removeItem(`added_${variantId}`);
        }
    }
}

// Listen for cart cleared events
window.addEventListener('storage', function(e) {
    if (e.key === 'cart_cleared') {
        console.log('Cart cleared event received on product detail page');
        resetCartButton();
        updateCartBadge(0);
    }
});

// Check cart status for current variant on page load
document.addEventListener('DOMContentLoaded', function() {
    const currentVariantId = selectedVariantId || document.getElementById('current-variant-id')?.value;
    if (currentVariantId) {
        checkCartForVariant(currentVariantId);
    }
});
    </script>
</body>
</html>