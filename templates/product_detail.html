<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #431405;
            --background-color: #fff8f5;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            line-height: 1.6;
        }
        
        .breadcrumb {
            background: transparent;
            padding: 0;
        }
        
        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .product-image {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .thumbnail {
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .thumbnail.active {
            border-color: var(--primary-color);
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
        }
        
        .stock-badge {
            font-size: 0.9rem;
            padding: 5px 12px;
        }
        
        .discount-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .btn-add-cart {
            background-color: #8B0000;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            transition: all 0.3s;
        }
        
        .btn-add-cart:hover {
            background-color: #5a0c1d;
            transform: translateY(-2px);
        }
        
        .btn-add-cart:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .variant-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .variant-option:hover {
            border-color: var(--primary-color);
            background-color: #fff8f5;
        }
        
        .variant-option.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }
        
        .zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .zoom-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .close-zoom {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
        
        .related-product {
            transition: transform 0.3s;
        }
        
        .related-product:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- Navigation Header (Same as your homepage) -->
    <!-- Include your header here -->

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                {% for crumb in breadcrumbs %}
                    {% if not forloop.last %}
                        <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.name }}</a></li>
                    {% else %}
                        <li class="breadcrumb-item active">{{ crumb.name }}</li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>

        <div class="row">
            <!-- Product Images -->
            <div class="col-md-6">
                <div class="product-image mb-4">
                    <img 
                        id="mainImage" 
                        src="{% if primary_image %}{{ primary_image.image.url }}{% elif product.main_image %}{{ product.main_image.url }}{% else %}https://via.placeholder.com/500x500?text=No+Image{% endif %}" 
                        alt="{{ product.name }}" 
                        class="img-fluid w-100"
                        style="height: 500px; object-fit: cover; cursor: zoom-in;"
                        onclick="openZoom()"
                    >
                </div>
                
                <!-- Thumbnail Gallery -->
                {% if product_images %}
                <div class="row">
                    {% for image in product_images %}
                    <div class="col-3 mb-3">
                        <img 
                            src="{{ image.image.url }}" 
                            alt="{{ product.name }}" 
                            class="img-fluid thumbnail {% if forloop.first %}active{% endif %}"
                            style="height: 100px; object-fit: cover;"
                            onclick="changeMainImage('{{ image.image.url }}', this)"
                        >
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Product Details -->
            <div class="col-md-6">
                <h1 class="h2 mb-3">{{ product.name }}</h1>
                
                <!-- Ratings -->
                <div class="d-flex align-items-center mb-3">
                    <div class="text-warning me-2">
                        {% with rating=product.avg_rating|default:4.0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>
                    <span class="text-muted">({{ product.rating_count }} reviews)</span>
                </div>

                <!-- Variant Selection -->
                {% if variants %}
                <div class="mb-4">
                    <h5>Select Variant</h5>
                    <div id="variant-options">
                        {% for variant in variants %}
                        <div class="variant-option {% if forloop.first %}selected{% endif %}" 
                             data-variant-id="{{ variant.id }}"
                             data-price="{{ variant.price }}"
                             data-discount-price="{{ variant.discount_price|default:'' }}"
                             data-stock="{{ variant.stock }}"
                             data-sku="{{ variant.sku }}"
                             data-volume="{{ variant.volume_ml }}"
                             data-gender="{{ variant.gender }}"
                             onclick="selectVariant(this)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ variant.volume_ml }}ml - {{ variant.gender }}</strong>
                                    <div class="small">
                                        {% if variant.discount_price %}
                                            <span class="text-danger fw-bold">‚Çπ{{ variant.discount_price }}</span>
                                            <span class="original-price ms-2">‚Çπ{{ variant.price }}</span>
                                        {% else %}
                                            <span class="fw-bold">‚Çπ{{ variant.price }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="d-block {% if variant.stock > 10 %}text-success{% elif variant.stock > 0 %}text-warning{% else %}text-danger{% endif %}">
                                        {% if variant.stock > 10 %}In Stock{% elif variant.stock > 0 %}Only {{ variant.stock }} left{% else %}Out of Stock{% endif %}
                                    </small>
                                    <!-- <small class="text-muted">SKU: {{ variant.sku }}</small> -->
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Selected Variant Details -->
                <div class="mb-4 p-3 border rounded bg-light">
                    <h6>Selected Variant Details</h6>
                    <div id="selected-variant-details">
                        {% with first_variant=variants.first %}
                        <div class="row small">
                            <div class="col-6">
                                <strong>Volume:</strong> {{ first_variant.volume_ml }}ml
                            </div>
                            <div class="col-6">
                                <strong>Gender:</strong> {{ first_variant.gender }}
                            </div>
                            <div class="col-6">
                                <strong>Price:</strong> 
                                {% if first_variant.discount_price %}
                                    <span class="text-danger">‚Çπ{{ first_variant.discount_price }}</span>
                                    <small class="original-price">‚Çπ{{ first_variant.price }}</small>
                                {% else %}
                                    ‚Çπ{{ first_variant.price }}
                                {% endif %}
                            </div>
                            <div class="col-6">
                                <strong>Stock:</strong> 
                                <span class="{% if first_variant.stock > 10 %}text-success{% elif first_variant.stock > 0 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ first_variant.stock }}
                                </span>
                            </div>
                            <div class="col-12 mt-2">
                                <!-- <strong>SKU:</strong> {{ first_variant.sku }} -->
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                </div>
                {% endif %}

                <!-- Description -->
                <div class="mb-4">
                    <h5>Description</h5>
                    <p class="text-muted">{{ product.description }}</p>
                </div>

                <!-- Product Details -->
                <div class="mb-4">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Brand:</strong></td>
                            <td>{{ product.brand|default:"Not specified" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fragrance Type:</strong></td>
                            <td>{{ product.fragrance_type|default:"Not specified" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Occasion:</strong></td>
                            <td>{{ product.occasion|default:"All occasions" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Base SKU:</strong></td>
                            <td>{{ product.sku }}</td>
                        </tr>
                    </table>
                </div>

                <!-- Add to Cart -->
                <div class="d-grid gap-2 d-md-flex">
                    {% csrf_token %} 
                    {% if variants and variants.first.stock > 0 %}
                        <button class="btn btn-add-cart flex-fill" id="add-to-cart-btn">
                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        </button>

                        
                    <a href="{% url 'cart' %}" class="icon-btn position-relative text-decoration-none">
    <i class="fas fa-shopping-cart"></i>
    {% if cart_item_count > 0 %}
    <span class="cart-count">{{ cart_item_count }}</span>
    {% else %}
    <span class="cart-count" style="display: none;">0</span>
    {% endif %}
</a>
                    {% else %}
                        <button class="btn btn-add-cart flex-fill" disabled>
                            <i class="fas fa-times-circle me-2"></i>Out of Stock
                        </button>
                    {% endif %}
                </div>

                <!-- Additional Info -->
                <div class="mt-4 pt-4 border-top">
                    <div class="row text-center">
                        <div class="col-4">
                            <i class="fas fa-shipping-fast text-primary mb-2"></i>
                            <p class="small mb-0">Free Shipping</p>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-undo-alt text-primary mb-2"></i>
                            <p class="small mb-0">Easy Returns</p>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-shield-alt text-primary mb-2"></i>
                            <p class="small mb-0">Secure Payment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Customer Reviews</h3>
                
                {% if product.rating_count > 0 %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h2 class="text-primary">{{ product.avg_rating|default:0 }}</h2>
                                <div class="text-warning mb-2">
                                    {% with rating=product.avg_rating|default:0 %}
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                                <p class="text-muted">Based on {{ product.rating_count }} reviews</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <!-- Sample reviews - you can replace with real reviews -->
                        <div class="review mb-4">
                            <div class="d-flex justify-content-between">
                                <h6>John Doe</h6>
                                <small class="text-muted">2 weeks ago</small>
                            </div>
                            <div class="text-warning mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                            <p class="text-muted">Amazing fragrance! Long lasting and perfect for daily use.</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No reviews yet</h5>
                    <p class="text-muted">Be the first to review this product!</p>
                    <button class="btn btn-outline-primary">Write a Review</button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Related Products -->
        {% if related_products %}
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Related Products</h3>
                <div class="row">
                    {% for related in related_products %}
                    <div class="col-lg-3 col-md-4 col-6 mb-4">
                        <div class="card related-product h-100">
                            <a href="{% url 'product_detail' related.id %}">
                                <img 
                                    src="{% if related.main_image %}{{ related.main_image.url }}{% else %}https://via.placeholder.com/300x300?text=No+Image{% endif %}" 
                                    class="card-img-top" 
                                    alt="{{ related.name }}"
                                    style="height: 200px; object-fit: cover;"
                                >
                            </a>
                            <div class="card-body">
                                <h6 class="card-title">{{ related.name }}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <!-- Show price range for related products -->
                                    {% if related.min_price == related.max_price %}
                                        <span class="text-dark fw-bold">‚Çπ{{ related.min_price }}</span>
                                    {% else %}
                                        <span class="text-dark fw-bold">‚Çπ{{ related.min_price }} - ‚Çπ{{ related.max_price }}</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ related.variants.count }} variants</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Image Zoom Modal -->
    <div id="zoomModal" class="zoom-modal">
        <span class="close-zoom" onclick="closeZoom()">&times;</span>
        <img id="zoomedImage" src="" alt="">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedVariantId = {% if variants %}{{ variants.first.id }}{% else %}null{% endif %};

        // Image Gallery Functionality
        function changeMainImage(src, element) {
            document.getElementById('mainImage').src = src;
            document.getElementById('zoomedImage').src = src;
            
            // Remove active class from all thumbnails
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            
            // Add active class to clicked thumbnail
            element.classList.add('active');
        }
        
        // Image Zoom Functionality
        function openZoom() {
            document.getElementById('zoomModal').style.display = 'flex';
        }
        
        function closeZoom() {
            document.getElementById('zoomModal').style.display = 'none';
        }
        
        // Close modal when clicking outside image
        document.getElementById('zoomModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeZoom();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeZoom();
            }
        });

        // Variant Selection Functionality
        function selectVariant(element) {
            // Remove selected class from all variants
            document.querySelectorAll('.variant-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked variant
            element.classList.add('selected');
            
            // Update selected variant ID
            selectedVariantId = element.dataset.variantId;
            
            // Update variant details display
            updateVariantDetails(element);
            
            // Update add to cart button
            updateAddToCartButton(parseInt(element.dataset.stock));
        }
        
        function updateVariantDetails(element) {
            const detailsHtml = `
                <div class="row small">
                    <div class="col-6">
                        <strong>Volume:</strong> ${element.dataset.volume}ml
                    </div>
                    <div class="col-6">
                        <strong>Gender:</strong> ${element.dataset.gender}
                    </div>
                    <div class="col-6">
                        <strong>Price:</strong> 
                        ${element.dataset.discountPrice ? 
                            `<span class="text-danger">‚Çπ${element.dataset.discountPrice}</span>
                             <small class="original-price">‚Çπ${element.dataset.price}</small>` :
                            `‚Çπ${element.dataset.price}`
                        }
                    </div>
                    <div class="col-6">
                        <strong>Stock:</strong> 
                        <span class="${parseInt(element.dataset.stock) > 10 ? 'text-success' : parseInt(element.dataset.stock) > 0 ? 'text-warning' : 'text-danger'}">
                            ${element.dataset.stock}
                        </span>
                    </div>
                    <div class="col-12 mt-2">
                        <strong>SKU:</strong> ${element.dataset.sku}
                    </div>
                </div>
            `;
            
            document.getElementById('selected-variant-details').innerHTML = detailsHtml;
        }
        
        function updateAddToCartButton(stock) {
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (stock > 0) {
                addToCartBtn.disabled = false;
                addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Add to Cart';
            } else {
                addToCartBtn.disabled = true;
                addToCartBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Out of Stock';
            }
        }

// Add to cart functionality
document.getElementById('add-to-cart-btn')?.addEventListener('click', function() {
    if (selectedVariantId) {
        console.log('üõí DEBUG: Add to cart clicked, variant ID:', selectedVariantId);
        
        const quantity = 1; // Default quantity
        
        // Get CSRF token - multiple ways to find it
        let csrfToken = '';
        
        // Method 1: Look for hidden input
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
            console.log('üõí DEBUG: CSRF token found via input field');
        }
        
        // Method 2: Look for cookie (fallback)
        if (!csrfToken) {
            csrfToken = getCookie('csrftoken');
            if (csrfToken) {
                console.log('üõí DEBUG: CSRF token found via cookie');
            }
        }
        
        // Method 3: Use Django template variable (fallback)
        if (!csrfToken && typeof window.CSRF_TOKEN !== 'undefined') {
            csrfToken = window.CSRF_TOKEN;
            console.log('üõí DEBUG: CSRF token found via window variable');
        }
        
        if (!csrfToken) {
            console.error('‚ùå DEBUG: CSRF token not found by any method');
            showNotification('Security error: Please refresh the page and try again.', 'error');
            return;
        }
        // Method 4: Look for meta tag
if (!csrfToken) {
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        csrfToken = csrfMeta.getAttribute('content');
        console.log('üõí DEBUG: CSRF token found via meta tag');
    }
}
        console.log('üõí DEBUG: CSRF token found:', csrfToken.substring(0, 10) + '...');
        
        // Create form data
        const formData = new FormData();
        formData.append('quantity', quantity);
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        const url = `/cart/add/${selectedVariantId}/`;
        console.log('üõí DEBUG: Making POST request to:', url);
        
        // Make AJAX request
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('üõí DEBUG: Response status:', response.status, response.statusText);
            
            // Check content type
            const contentType = response.headers.get('content-type');
            console.log('üõí DEBUG: Content-Type:', contentType);
            
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    console.log('üõí DEBUG: JSON response data:', data);
                    return { type: 'json', data: data };
                });
            } else {
                // If it's HTML, it might be a redirect or error page
                console.log('üõí DEBUG: HTML response received');
                return response.text().then(html => {
                    console.log('üõí DEBUG: HTML response length:', html.length);
                    // Check if it's a redirect to login (user not authenticated)
                    if (html.includes('login') || html.includes('Log in')) {
                        return { type: 'redirect', data: '/accounts/login/' };
                    }
                    return { type: 'html', data: html };
                });
            }
        })
        .then(result => {
            if (result.type === 'json') {
                // Handle JSON response
                const data = result.data;
                if (data.success) {
                    showNotification(data.message || 'Product added to cart successfully!', 'success');
                    
                    // Update cart count in header
                    if (data.cart_total_items !== undefined) {
                        updateCartCount(data.cart_total_items);
                    }
                    
                    // Redirect to cart page after short delay
                    setTimeout(() => {
                        window.location.href = '{% url "cart" %}';
                    }, 1500);
                } else {
                    showNotification(data.message || 'Error adding product to cart', 'error');
                }
            } else if (result.type === 'redirect') {
                // Handle redirect (usually to login page)
                console.log('üõí DEBUG: Redirect detected to:', result.data);
                showNotification('Please log in to add items to cart', 'warning');
                setTimeout(() => {
                    window.location.href = result.data;
                }, 2000);
            } else {
                // Handle HTML response (redirect happened)
                console.log('üõí DEBUG: HTML response - assuming redirect worked');
                showNotification('Product added to cart! Redirecting...', 'success');
            }
        })
        .catch(error => {
            console.error('‚ùå DEBUG: Fetch error:', error);
            console.error('‚ùå DEBUG: Error details:', error.message);
            showNotification('Network error: Could not add to cart. Please try again.', 'error');
        });
    } else {
        console.error('‚ùå DEBUG: No variant selected');
        showNotification('Please select a variant first', 'error');
    }
});

// Helper function to get cookie value
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    // Remove any existing notifications
    document.querySelectorAll('.custom-notification').forEach(el => el.remove());
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = `custom-notification alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} position-fixed`;
    notification.style.cssText = `
        top: 20px; 
        right: 20px; 
        z-index: 9999; 
        min-width: 300px;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.innerHTML = `
        <strong>${type === 'success' ? '‚úÖ Success!' : type === 'warning' ? '‚ö†Ô∏è Warning!' : '‚ùå Error!'}</strong>
        <div>${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function updateCartCount(count) {
    const cartCountElements = document.querySelectorAll('.cart-count');
    console.log('üõí DEBUG: Updating cart count to:', count, 'found', cartCountElements.length, 'elements');
    cartCountElements.forEach(element => {
        element.textContent = count;
        element.style.display = count > 0 ? 'flex' : 'none';
    });
}
    </script>
</body>
</html>